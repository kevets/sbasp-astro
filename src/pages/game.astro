---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';
---
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Squares, Spaces & Pairs</title>
<style>
    body {
        font-family: Arial, sans-serif;
        text-align: center;
        background-color: #fafafa;
    }
    h1 { margin-top: 10px; }
    .board {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 20px;
    }
    .left-wing, .right-wing {
        display: flex;
        flex-direction: column;
        margin: 0 20px;
    }
    .pair { display: flex; }
    .center {
        display: grid;
        grid-template-columns: repeat(3, 50px);
        grid-template-rows: repeat(3, 50px);
        gap: 5px;
    }
    .cell {
        width: 50px;
        height: 50px;
        border: 1px solid black;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 30px;
        cursor: pointer;
        background-color: #f9f9f9;
    }
    .cell:hover { background-color: #e0e0e0; }
    #message { font-size: 20px; margin: 10px; }
    #timer { font-size: 24px; color: red; }

    /* --- Scoreboard --- */
    .scoreboard {
        display: flex;
        justify-content: center;
        gap: 40px;
        margin-top: 20px;
    }
    .score-panel {
        border: 3px solid #333;
        border-radius: 10px;
        padding: 10px 20px;
        width: 200px;
        background-color: #f2f2f2;
        transition: box-shadow 0.3s ease, border-color 0.3s ease;
    }
    .score-panel h2 { margin-bottom: 10px; }
    .score-item { font-size: 18px; margin: 4px 0; }

    .leader-x { border-color: #0066ff; box-shadow: 0 0 15px #0066ff; }
    .leader-o { border-color: #ff3333; box-shadow: 0 0 15px #ff3333; }

    /* --- 3D Overview Map --- */
    .overview {
        position: relative;
        display: inline-block;
        margin-top: 30px;
    }
    #overviewCanvas {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
    }
    #overviewImage {
        width: 500px;
        height: auto;
        border: 2px solid #333;
        border-radius: 10px;
    }
</style>
</head>
<body>

<h1>Squares, Spaces & Pairs</h1>
<div id="message">X's turn.</div>
<div id="timer">10</div>

<!-- Main Game Board -->
<div class="board">
    <div class="left-wing">
        <!-- Left squares -->
        <div class="pair"><div class="cell square" data-type="square" data-section="0" data-index="0"></div><div class="cell square" data-type="square" data-section="0" data-index="1"></div></div>
        <div class="pair"><div class="cell square" data-type="square" data-section="1" data-index="0"></div><div class="cell square" data-type="square" data-section="1" data-index="1"></div></div>
        <div class="pair"><div class="cell square" data-type="square" data-section="2" data-index="0"></div><div class="cell square" data-type="square" data-section="2" data-index="1"></div></div>
        <div class="pair"><div class="cell square" data-type="square" data-section="3" data-index="0"></div><div class="cell square" data-type="square" data-section="3" data-index="1"></div></div>
        <div class="pair"><div class="cell square" data-type="square" data-section="4" data-index="0"></div><div class="cell square" data-type="square" data-section="4" data-index="1"></div></div>
        <div class="pair"><div class="cell square" data-type="square" data-section="5" data-index="0"></div><div class="cell square" data-type="square" data-section="5" data-index="1"></div></div>
    </div>
    <div class="center">
        <!-- Center spaces -->
        <div class="cell space" data-type="space" data-row="0" data-col="0"></div>
        <div class="cell space" data-type="space" data-row="0" data-col="1"></div>
        <div class="cell space" data-type="space" data-row="0" data-col="2"></div>
        <div class="cell space" data-type="space" data-row="1" data-col="0"></div>
        <div class="cell space" data-type="space" data-row="1" data-col="1"></div>
        <div class="cell space" data-type="space" data-row="1" data-col="2"></div>
        <div class="cell space" data-type="space" data-row="2" data-col="0"></div>
        <div class="cell space" data-type="space" data-row="2" data-col="1"></div>
        <div class="cell space" data-type="space" data-row="2" data-col="2"></div>
    </div>
    <div class="right-wing">
        <!-- Right squares -->
        <div class="pair"><div class="cell square" data-type="square" data-section="6" data-index="0"></div><div class="cell square" data-type="square" data-section="6" data-index="1"></div></div>
        <div class="pair"><div class="cell square" data-type="square" data-section="7" data-index="0"></div><div class="cell square" data-type="square" data-section="7" data-index="1"></div></div>
        <div class="pair"><div class="cell square" data-type="square" data-section="8" data-index="0"></div><div class="cell square" data-type="square" data-section="8" data-index="1"></div></div>
        <div class="pair"><div class="cell square" data-type="square" data-section="9" data-index="0"></div><div class="cell square" data-type="square" data-section="9" data-index="1"></div></div>
        <div class="pair"><div class="cell square" data-type="square" data-section="10" data-index="0"></div><div class="cell square" data-type="square" data-section="10" data-index="1"></div></div>
        <div class="pair"><div class="cell square" data-type="square" data-section="11" data-index="0"></div><div class="cell square" data-type="square" data-section="11" data-index="1"></div></div>
    </div>
</div>

<!-- Scoreboard -->
<div class="scoreboard">
    <div class="score-panel" id="x-panel">
        <h2>Player X</h2>
        <div class="score-item">Squares: <span id="x-squares">0</span></div>
        <div class="score-item">Spaces: <span id="x-spaces">0</span></div>
        <div class="score-item">Pairs: <span id="x-pairs">0</span></div>
        <div class="score-item"><strong>Total: <span id="x-total">0</span></strong></div>
    </div>
    <div class="score-panel" id="o-panel">
        <h2>Player O</h2>
        <div class="score-item">Squares: <span id="o-squares">0</span></div>
        <div class="score-item">Spaces: <span id="o-spaces">0</span></div>
        <div class="score-item">Pairs: <span id="o-pairs">0</span></div>
        <div class="score-item"><strong>Total: <span id="o-total">0</span></strong></div>
    </div>
</div>

<!-- 3D Overview -->
<div class="overview">
    <img id="overviewImage" src="\SquaresNSpaces-blank.png" alt="3D Overview">
    <canvas id="overviewCanvas" width="500" height="500"></canvas>
</div>

<script>
let currentPlayer = 'X';
let timerId;
let remainingTime = 10;
let gameOver = false;
const timeLimit = 10;

const spaces = Array(3).fill().map(() => Array(3).fill(null));
const sections = Array(12).fill().map(() => Array(2).fill(null));

const message = document.getElementById('message');
const timerDisplay = document.getElementById('timer');
const cells = document.querySelectorAll('.cell');
const canvas = document.getElementById('overviewCanvas');
const ctx = canvas.getContext('2d');

cells.forEach(cell => cell.addEventListener('click', handleClick));

function handleClick(e) {
    if (gameOver || remainingTime <= 0) return;
    const cell = e.target;
    if (cell.textContent) return;

    const type = cell.dataset.type;
    if (type === 'space') {
        const row = parseInt(cell.dataset.row);
        const col = parseInt(cell.dataset.col);
        if (spaces[row][col]) return;
        spaces[row][col] = currentPlayer;
    } else if (type === 'square') {
        const section = parseInt(cell.dataset.section);
        const index = parseInt(cell.dataset.index);
        if (sections[section][index]) return;
        sections[section][index] = currentPlayer;
    }

    cell.textContent = currentPlayer;
    clearInterval(timerId);
    updateScoreboard();
    updateOverview();
    checkEndGame();
    if (!gameOver) {
        currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
        message.textContent = `${currentPlayer}'s turn.`;
        startTimer();
    }
}

function startTimer() {
    remainingTime = timeLimit;
    timerDisplay.textContent = remainingTime;
    timerId = setInterval(() => {
        remainingTime--;
        timerDisplay.textContent = remainingTime;
        if (remainingTime <= 0) {
            clearInterval(timerId);
            message.textContent = `${currentPlayer} lost turn.`;
            currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
            message.textContent = `${currentPlayer}'s turn.`;
            if (!gameOver) startTimer();
        }
    }, 1000);
}

function checkEndGame() {
    if (isThreeInARow() || areSpacesFilled()) {
        gameOver = true;
        clearInterval(timerId);
        const scores = calculateScores();
        message.textContent = `Game over. X score: ${scores.X.total}, O score: ${scores.O.total}. `;
        if (scores.X.total > scores.O.total) message.textContent += 'X wins!';
        else if (scores.O.total > scores.X.total) message.textContent += 'O wins!';
        else message.textContent += 'Tie!';
        timerDisplay.textContent = '';
    }
}

function isThreeInARow() {
    for (let i = 0; i < 3; i++) {
        if (spaces[i][0] && spaces[i][0] === spaces[i][1] && spaces[i][1] === spaces[i][2]) return true;
    }
    for (let i = 0; i < 3; i++) {
        if (spaces[0][i] && spaces[0][i] === spaces[1][i] && spaces[1][i] === spaces[2][i]) return true;
    }
    if (spaces[0][0] && spaces[0][0] === spaces[1][1] && spaces[1][1] === spaces[2][2]) return true;
    if (spaces[0][2] && spaces[0][2] === spaces[1][1] && spaces[1][1] === spaces[2][0]) return true;
    return false;
}

function areSpacesFilled() {
    return spaces.every(row => row.every(cell => cell !== null));
}

function calculateScores() {
    const scores = {
        X: { squares: 0, spaces: 0, pairs: 0, total: 0 },
        O: { squares: 0, spaces: 0, pairs: 0, total: 0 }
    };
    spaces.flat().forEach(cell => { if (cell) scores[cell].spaces++; });
    sections.flat().forEach(cell => { if (cell) scores[cell].squares++; });
    sections.forEach(section => {
        if (section[0] && section[0] === section[1]) scores[section[0]].pairs++;
    });
    scores.X.total = scores.X.squares + scores.X.spaces + scores.X.pairs;
    scores.O.total = scores.O.squares + scores.O.spaces + scores.O.pairs;
    return scores;
}

function updateScoreboard() {
    const scores = calculateScores();
    document.getElementById('x-squares').textContent = scores.X.squares;
    document.getElementById('x-spaces').textContent = scores.X.spaces;
    document.getElementById('x-pairs').textContent = scores.X.pairs;
    document.getElementById('x-total').textContent = scores.X.total;

    document.getElementById('o-squares').textContent = scores.O.squares;
    document.getElementById('o-spaces').textContent = scores.O.spaces;
    document.getElementById('o-pairs').textContent = scores.O.pairs;
    document.getElementById('o-total').textContent = scores.O.total;

    const xPanel = document.getElementById('x-panel');
    const oPanel = document.getElementById('o-panel');
    xPanel.classList.remove('leader-x');
    oPanel.classList.remove('leader-o');
    if (scores.X.total > scores.O.total) xPanel.classList.add('leader-x');
    else if (scores.O.total > scores.X.total) oPanel.classList.add('leader-o');
}

function updateOverview() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.font = "bold 24px Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    // Approximate 3D layout coordinates for 9 spaces (front/middle plane)
    const coords = [
        [180,120],[250,120],[320,120],
        [180,220],[250,220],[320,220],
        [180,320],[250,320],[320,320]
    ];
    for (let r=0; r<3; r++) {
        for (let c=0; c<3; c++) {
            const val = spaces[r][c];
            if (val) {
                const [x,y] = coords[r*3+c];
                ctx.fillStyle = val==='X' ? "#0066ff" : "#ff3333";
                ctx.fillText(val, x, y);
            }
        }
    }
}

startTimer();
updateScoreboard();
updateOverview();
</script>
</body>
</html>
